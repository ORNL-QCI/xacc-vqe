/*******************************************************************************
 * Copyright (c) 2018 UT-Battelle, LLC.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * and Eclipse Distribution License v1.0 which accompanies this
 * distribution. The Eclipse Public License is available at
 * http://www.eclipse.org/legal/epl-v10.html and the Eclipse Distribution
 *License is available at https://eclipse.org/org/documents/edl-v10.php
 *
 * Contributors:
 *   Alexander J. McCaskey - initial API and implementation
 *******************************************************************************/
#include <gtest/gtest.h>
#include "XACC.hpp"
#include "VQERestartDecorator.hpp"
#include "PauliOperator.hpp"
#include <fstream>
#include "xacc_service.hpp"

using namespace xacc::vqe;
using namespace xacc::quantum;

const std::string restartFile = R"restartFile({
    "AcceleratorBuffer": {
        "name": "q",
        "size": 4,
        "Information": {
            "accelerator": "local-ibm",
            "algorithm": "vqe",
            "ansatz-qasm": "Rx(t0) q0\nRx(t1) q1\nRx(t2) q2\nRx(t3) q3\nCNOT q0,q1\nCNOT q1,q2\nCNOT q2,q3\nRz(t4) q0\nRx(t5) q0\nRz(t6) q0\nRz(t7) q1\nRx(t8) q1\nRz(t9) q1\nRz(t10) q2\nRx(t11) q2\nRz(t12) q2\nRz(t13) q3\nRx(t14) q3\nRz(t15) q3\n",
            "ansatz-qasm-py": "def foo(t0,t1,t2,t3,t4,t5,t6,t7,t8,t9,t10,t11,t12,t13,t14,t15):\n   Rx(t0, 0)\n   Rx(t1, 1)\n   Rx(t2, 2)\n   Rx(t3, 3)\n   CNOT(0, 1)\n   CNOT(1, 2)\n   CNOT(2, 3)\n   Rz(t4, 0)\n   Rx(t5, 0)\n   Rz(t6, 0)\n   Rz(t7, 1)\n   Rx(t8, 1)\n   Rz(t9, 1)\n   Rz(t10, 2)\n   Rx(t11, 2)\n   Rz(t12, 2)\n   Rz(t13, 3)\n   Rx(t14, 3)\n   Rz(t15, 3)\n",
            "benchmark-time": 15.628023386001587,
            "circuit-depth": 7,
            "connectivity": "[[0, 1],[1,2],[2, 3]]",
            "converge-ro-error": "True",
            "file-name": "h2-local-ibm.ini",
            "hamiltonian": "(0.174073,0) Z2 Z3 + (0.1202,0) Z1 Z3 + (0.165607,0) Z1 Z2 + (0.165607,0) Z0 Z3 + (0.1202,0) Z0 Z2 + (-0.0454063,0) Y0 Y1 X2 X3 + (-0.220041,0) Z3 + (-0.106477,0) + (0.17028,0) Z0 + (-0.220041,0) Z2 + (0.17028,0) Z1 + (-0.0454063,0) X0 X1 Y2 Y3 + (0.0454063,0) X0 Y1 Y2 X3 + (0.168336,0) Z0 Z1 + (0.0454063,0) Y0 X1 X2 Y3",
            "initial-parameters": "[3.662630941 , -3.354225877,  0.4685765687,   4.142662282,  -2.268016251,   0.337559469 ,  -3.55948587,  -1.450570356 ,  3.216719569,    3.11883138, -0.7491117302, -0.2662735029 , -2.523401205, -0.2607680893,   1.997921299, -0.4341298591]",
            "layers": "1",
            "local-ibm-ro-error": ".01,.1",
            "molecule-generator": "xaccKernelH2",
            "n-shots": "8192",
            "name": "hwe",
            "optimizer": "scipy-cobyla",
            "options": "{'tol':1e-3,'disp':True, 'maxiter':2}",
            "readout-error": "True",
            "ro-error-file": "/root/.xacc_cache/ro_characterization/local-ibm_NullBackend_ro_error_Tue_Nov__6_02_35_15_2018.json",
            "vqe-angles": [
                4.662630941,
                -3.354225877,
                0.4685765687,
                4.142662282,
                -2.268016251,
                0.337559469,
                -3.55948587,
                -1.450570356,
                3.216719569,
                3.11883138,
                -0.7491117302,
                -0.2662735029,
                -2.523401205,
                -0.2607680893,
                1.997921299,
                -0.4341298591
            ],
            "vqe-energies": [
                -0.9314003550178718,
                -0.41317067275981458
            ],
            "vqe-energy": -0.9314003550178718,
            "vqe-nQPU-calls": 28,
            "vqe-parameters": [
                "3.662630941,-3.354225877,0.4685765687,4.142662282,-2.268016251,0.337559469,-3.55948587,-1.450570356,3.216719569,3.11883138,-0.7491117302,-0.2662735029,-2.523401205,-0.2607680893,1.997921299,-0.4341298591",
                "4.662630941,-3.354225877,0.4685765687,4.142662282,-2.268016251,0.337559469,-3.55948587,-1.450570356,3.216719569,3.11883138,-0.7491117302,-0.2662735029,-2.523401205,-0.2607680893,1.997921299,-0.4341298591"
            ]
        },
        "Measurements": {},
        "Children": [
            {
                "name": "I",
                "Information": {
                    "coefficient": -0.10647701562838583,
                    "exp-val-z": 1.0,
                    "kernel": "I",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 1.0
                },
                "Measurements": {}
            },
            {
                "name": "Z2Z3",
                "Information": {
                    "coefficient": 0.17407289234592944,
                    "exp-val-z": 0.855712890625,
                    "kernel": "Z2Z3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.920687246910649
                },
                "Measurements": {
                    "0000": 6846,
                    "0100": 287,
                    "1000": 304,
                    "1100": 755
                }
            },
            {
                "name": "Z1Z3",
                "Information": {
                    "coefficient": 0.12020049052387275,
                    "exp-val-z": -0.667236328125,
                    "kernel": "Z1Z3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8489746973741928
                },
                "Measurements": {
                    "0000": 863,
                    "0010": 580,
                    "1000": 6249,
                    "1010": 500
                }
            },
            {
                "name": "Z1Z2",
                "Information": {
                    "coefficient": 0.165606823439243,
                    "exp-val-z": -0.674072265625,
                    "kernel": "Z1Z2",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8562320930863445
                },
                "Measurements": {
                    "0000": 816,
                    "0010": 569,
                    "0100": 6288,
                    "0110": 519
                }
            },
            {
                "name": "Z0Z3",
                "Information": {
                    "coefficient": 0.165606823439243,
                    "exp-val-z": -0.650390625,
                    "kernel": "Z0Z3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8280468527112479
                },
                "Measurements": {
                    "0000": 927,
                    "0001": 522,
                    "1000": 6238,
                    "1001": 505
                }
            },
            {
                "name": "Z0Z2",
                "Information": {
                    "coefficient": 0.12020049052387275,
                    "exp-val-z": -0.644775390625,
                    "kernel": "Z0Z2",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8194975219356979
                },
                "Measurements": {
                    "0000": 906,
                    "0001": 547,
                    "0100": 6190,
                    "0101": 549
                }
            },
            {
                "name": "Y0Y1X2X3",
                "Information": {
                    "coefficient": -0.045406332915370248,
                    "exp-val-z": 0.193603515625,
                    "kernel": "Y0Y1X2X3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.3106438929084366
                },
                "Measurements": {
                    "0000": 856,
                    "0001": 223,
                    "0010": 300,
                    "0011": 441,
                    "0100": 587,
                    "0101": 413,
                    "0110": 542,
                    "0111": 191,
                    "1000": 885,
                    "1001": 504,
                    "1010": 610,
                    "1011": 411,
                    "1100": 1078,
                    "1101": 299,
                    "1110": 407,
                    "1111": 445
                }
            },
            {
                "name": "Z3",
                "Information": {
                    "coefficient": -0.22004129872865026,
                    "exp-val-z": 0.7373046875,
                    "kernel": "Z3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.7272852612711981
                },
                "Measurements": {
                    "0000": 7116,
                    "1000": 1076
                }
            },
            {
                "name": "Z0",
                "Information": {
                    "coefficient": 0.1702801008507344,
                    "exp-val-z": -0.62939453125,
                    "kernel": "Z0",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8279778393351801
                },
                "Measurements": {
                    "0000": 1518,
                    "0001": 6674
                }
            },
            {
                "name": "Z2",
                "Information": {
                    "coefficient": -0.22004129872865023,
                    "exp-val-z": 0.744873046875,
                    "kernel": "Z2",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.7304359785449043
                },
                "Measurements": {
                    "0000": 7147,
                    "0100": 1045
                }
            },
            {
                "name": "Z1",
                "Information": {
                    "coefficient": 0.1702801008507344,
                    "exp-val-z": -0.664794921875,
                    "kernel": "Z1",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8539202200825309
                },
                "Measurements": {
                    "0000": 1373,
                    "0010": 6819
                }
            },
            {
                "name": "X0X1Y2Y3",
                "Information": {
                    "coefficient": -0.045406332915370248,
                    "exp-val-z": 0.23388671875,
                    "kernel": "X0X1Y2Y3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.3981896246674877
                },
                "Measurements": {
                    "0000": 591,
                    "0001": 475,
                    "0010": 652,
                    "0011": 544,
                    "0100": 355,
                    "0101": 483,
                    "0110": 629,
                    "0111": 322,
                    "1000": 370,
                    "1001": 709,
                    "1010": 880,
                    "1011": 283,
                    "1100": 651,
                    "1101": 259,
                    "1110": 422,
                    "1111": 567
                }
            },
            {
                "name": "X0Y1Y2X3",
                "Information": {
                    "coefficient": 0.045406332915370248,
                    "exp-val-z": -0.190185546875,
                    "kernel": "X0Y1Y2X3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.3189795000779454
                },
                "Measurements": {
                    "0000": 703,
                    "0001": 253,
                    "0010": 644,
                    "0011": 515,
                    "0100": 759,
                    "0101": 153,
                    "0110": 446,
                    "0111": 534,
                    "1000": 930,
                    "1001": 162,
                    "1010": 369,
                    "1011": 650,
                    "1100": 595,
                    "1101": 360,
                    "1110": 745,
                    "1111": 374
                }
            },
            {
                "name": "Z0Z1",
                "Information": {
                    "coefficient": 0.16833598609466289,
                    "exp-val-z": 0.61376953125,
                    "kernel": "Z0Z1",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.956371610267978
                },
                "Measurements": {
                    "0000": 656,
                    "0001": 861,
                    "0010": 721,
                    "0011": 5954
                }
            },
            {
                "name": "Y0X1X2Y3",
                "Information": {
                    "coefficient": 0.045406332915370248,
                    "exp-val-z": -0.1796875,
                    "kernel": "Y0X1X2Y3",
                    "parameters": [
                        3.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.2836753697966192
                },
                "Measurements": {
                    "0000": 650,
                    "0001": 511,
                    "0010": 403,
                    "0011": 332,
                    "0100": 701,
                    "0101": 190,
                    "0110": 179,
                    "0111": 516,
                    "1000": 1098,
                    "1001": 426,
                    "1010": 338,
                    "1011": 748,
                    "1100": 817,
                    "1101": 481,
                    "1110": 374,
                    "1111": 428
                }
            },
            {
                "name": "I",
                "Information": {
                    "coefficient": -0.10647701562838583,
                    "exp-val-z": 1.0,
                    "kernel": "I",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 1.0
                },
                "Measurements": {}
            },
            {
                "name": "Z2Z3",
                "Information": {
                    "coefficient": 0.17407289234592944,
                    "exp-val-z": 0.751220703125,
                    "kernel": "Z2Z3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.9380239095217485
                },
                "Measurements": {
                    "0000": 4085,
                    "0100": 494,
                    "1000": 525,
                    "1100": 3088
                }
            },
            {
                "name": "Z1Z3",
                "Information": {
                    "coefficient": 0.12020049052387275,
                    "exp-val-z": -0.658447265625,
                    "kernel": "Z1Z3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8484294218907852
                },
                "Measurements": {
                    "0000": 1070,
                    "0010": 3251,
                    "1000": 3542,
                    "1010": 329
                }
            },
            {
                "name": "Z1Z2",
                "Information": {
                    "coefficient": 0.165606823439243,
                    "exp-val-z": -0.677978515625,
                    "kernel": "Z1Z2",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8694225538813061
                },
                "Measurements": {
                    "0000": 998,
                    "0010": 3250,
                    "0100": 3623,
                    "0110": 321
                }
            },
            {
                "name": "Z0Z3",
                "Information": {
                    "coefficient": 0.165606823439243,
                    "exp-val-z": -0.65185546875,
                    "kernel": "Z0Z3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8456535131322104
                },
                "Measurements": {
                    "0000": 1086,
                    "0001": 3240,
                    "1000": 3526,
                    "1001": 340
                }
            },
            {
                "name": "Z0Z2",
                "Information": {
                    "coefficient": 0.12020049052387275,
                    "exp-val-z": -0.65478515625,
                    "kernel": "Z0Z2",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.8469199731335083
                },
                "Measurements": {
                    "0000": 1073,
                    "0001": 3196,
                    "0100": 3582,
                    "0101": 341
                }
            },
            {
                "name": "Y0Y1X2X3",
                "Information": {
                    "coefficient": -0.045406332915370248,
                    "exp-val-z": 0.418212890625,
                    "kernel": "Y0Y1X2X3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.6739894189659846
                },
                "Measurements": {
                    "0000": 931,
                    "0001": 364,
                    "0010": 398,
                    "0011": 760,
                    "0100": 334,
                    "0101": 687,
                    "0110": 702,
                    "0111": 241,
                    "1000": 447,
                    "1001": 737,
                    "1010": 663,
                    "1011": 227,
                    "1100": 827,
                    "1101": 164,
                    "1110": 208,
                    "1111": 502
                }
            },
            {
                "name": "Z3",
                "Information": {
                    "coefficient": -0.22004129872865026,
                    "exp-val-z": 0.10546875,
                    "kernel": "Z3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.013649524334758079
                },
                "Measurements": {
                    "0000": 4528,
                    "1000": 3664
                }
            },
            {
                "name": "Z0",
                "Information": {
                    "coefficient": 0.1702801008507344,
                    "exp-val-z": 0.034912109375,
                    "kernel": "Z0",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.0742382271468145
                },
                "Measurements": {
                    "0000": 4239,
                    "0001": 3953
                }
            },
            {
                "name": "Z2",
                "Information": {
                    "coefficient": -0.22004129872865023,
                    "exp-val-z": 0.11865234375,
                    "kernel": "Z2",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.02489341218539398
                },
                "Measurements": {
                    "0000": 4582,
                    "0100": 3610
                }
            },
            {
                "name": "Z1",
                "Information": {
                    "coefficient": 0.1702801008507344,
                    "exp-val-z": 0.061279296875,
                    "kernel": "Z1",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.03576341127922966
                },
                "Measurements": {
                    "0000": 4347,
                    "0010": 3845
                }
            },
            {
                "name": "X0X1Y2Y3",
                "Information": {
                    "coefficient": -0.045406332915370248,
                    "exp-val-z": 0.45068359375,
                    "kernel": "X0X1Y2Y3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.7313808545934726
                },
                "Measurements": {
                    "0000": 971,
                    "0001": 415,
                    "0010": 371,
                    "0011": 703,
                    "0100": 351,
                    "0101": 711,
                    "0110": 743,
                    "0111": 205,
                    "1000": 360,
                    "1001": 736,
                    "1010": 786,
                    "1011": 182,
                    "1100": 719,
                    "1101": 203,
                    "1110": 163,
                    "1111": 573
                }
            },
            {
                "name": "X0Y1Y2X3",
                "Information": {
                    "coefficient": 0.045406332915370248,
                    "exp-val-z": -0.38720703125,
                    "kernel": "X0Y1Y2X3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.6331994974400147
                },
                "Measurements": {
                    "0000": 525,
                    "0001": 764,
                    "0010": 853,
                    "0011": 272,
                    "0100": 813,
                    "0101": 338,
                    "0110": 254,
                    "0111": 647,
                    "1000": 748,
                    "1001": 418,
                    "1010": 259,
                    "1011": 606,
                    "1100": 308,
                    "1101": 536,
                    "1110": 715,
                    "1111": 136
                }
            },
            {
                "name": "Z0Z1",
                "Information": {
                    "coefficient": 0.16833598609466289,
                    "exp-val-z": 0.768310546875,
                    "kernel": "Z0Z1",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": 0.9806117044584239
                },
                "Measurements": {
                    "0000": 3848,
                    "0001": 454,
                    "0010": 495,
                    "0011": 3395
                }
            },
            {
                "name": "Y0X1X2Y3",
                "Information": {
                    "coefficient": 0.045406332915370248,
                    "exp-val-z": -0.369873046875,
                    "kernel": "Y0X1X2Y3",
                    "parameters": [
                        4.662630941,
                        -3.354225877,
                        0.4685765687,
                        4.142662282,
                        -2.268016251,
                        0.337559469,
                        -3.55948587,
                        -1.450570356,
                        3.216719569,
                        3.11883138,
                        -0.7491117302,
                        -0.2662735029,
                        -2.523401205,
                        -0.2607680893,
                        1.997921299,
                        -0.4341298591
                    ],
                    "ro-fixed-exp-val-z": -0.6048538770082274
                },
                "Measurements": {
                    "0000": 574,
                    "0001": 837,
                    "0010": 773,
                    "0011": 268,
                    "0100": 701,
                    "0101": 308,
                    "0110": 360,
                    "0111": 639,
                    "1000": 853,
                    "1001": 249,
                    "1010": 276,
                    "1011": 649,
                    "1100": 381,
                    "1101": 594,
                    "1110": 565,
                    "1111": 165
                }
            }
        ]
    }
})restartFile";

TEST(VQERestartDecoratorTester, checkSimple) {
  if (xacc::hasAccelerator("local-ibm")) {
    auto acc = xacc::getAccelerator("local-ibm");
    auto buffer = acc->createBuffer("buffer", 4);

    auto loaded = std::make_shared<xacc::AcceleratorBuffer>();
    std::istringstream is(restartFile);
    loaded->load(is);

    auto compiler = xacc::getService<xacc::Compiler>("xacc-py");
    const std::string src = mpark::get<std::string>(loaded->getInformation("ansatz-qasm-py"));

    auto f = compiler->compile(src, acc)->getKernel("foo");
    f = f->operator()(std::vector<double>(16));

    PauliOperator h;
    h.fromString(mpark::get<std::string>(loaded->getInformation("hamiltonian")));
    auto measureKernels = h.toXACCIR()->getKernels();

    for (auto& m : measureKernels) m->insertInstruction(0,f);

    std::ofstream out("tmp_test.ab");
    out << restartFile;
    out.close();
    xacc::setOption("vqe-restart-file", "tmp_test.ab");

    VQERestartDecorator decorator;
    decorator.setDecorated(acc);
    decorator.initialize();
    std::remove("tmp_test.ab");

    auto buffers = decorator.execute(buffer, measureKernels);

    EXPECT_EQ(buffers.size(), 14); // 15 - 1 I term

  }
}

int main(int argc, char **argv) {
  xacc::Initialize();
  ::testing::InitGoogleTest(&argc, argv);
  auto ret = RUN_ALL_TESTS();
  xacc::Finalize();
  return ret;
}
